# Data Model: CLI Tool Improvements for Language Porting

**Feature**: 022-cli-improvements  
**Date**: 2025-12-27

## Overview

This feature extends the CLI tool's output capabilities without modifying core pattern/gram data structures. The data model focuses on output formatting options and test suite generation structures.

## Core Entities

### OutputOptions

Represents the output formatting options that can be applied to any CLI command output.

**Fields**:
- `valueOnly :: Bool` - If `True`, output only the result value without metadata wrapper
- `deterministic :: Bool` - If `True`, use fixed values for metadata (timestamps, hashes) or exclude them
- `canonical :: Bool` - If `True`, ensure JSON keys are sorted alphabetically at all nesting levels

**Invariants**:
- When `deterministic` is `True`, `canonical` is automatically `True` (enforced by FR-011)
- Flags can be combined (FR-003, FR-010)

**Relationships**:
- Used by all CLI commands (Parse, Match, Transform, Generate, Validate, Convert)
- Passed alongside `OutputFormat` to output formatting functions

---

### TestSuite

Represents a collection of test cases in the test suite format specification.

**Fields**:
- `version :: Text` - Test suite format version (e.g., "1.0")
- `testCases :: [TestCase]` - Array of test case definitions

**Invariants**:
- `version` must be a valid version string (currently "1.0")
- `testCases` can be empty (for count=0 case)
- All test cases must be valid according to TestCase structure

**Relationships**:
- Generated by `generate --type suite` command
- Used for validation and port testing

---

### TestCase

Represents a single test case within a test suite.

**Fields**:
- `name :: Text` - Unique identifier for the test case (e.g., "test_case_001")
- `description :: Text` - Human-readable description of what the test case validates
- `input :: TestInput` - Input data for the test case
- `expected :: TestExpected` - Expected output for the test case
- `operations :: Maybe [TestOperation]` - Optional array of operations to test (match, transform, etc.)

**Invariants**:
- `name` must be unique within a test suite
- `input` and `expected` are required
- `operations` is optional (some test cases may only test parsing)

**Relationships**:
- Part of `TestSuite.testCases` array
- References pattern structures through `input` and `expected`

---

### TestInput

Represents the input data for a test case.

**Fields**:
- `type :: Text` - Type of input (e.g., "gram_notation")
- `value :: Text` - The actual input value (gram notation string)

**Invariants**:
- `type` must be a recognized input type (currently "gram_notation")
- `value` must be valid gram notation when `type` is "gram_notation"

**Relationships**:
- Used by `TestCase.input`

---

### TestExpected

Represents the expected output for a test case.

**Fields**:
- `type :: Text` - Type of expected output (e.g., "pattern")
- `value :: Value` - The expected pattern structure as JSON Value

**Invariants**:
- `type` must be a recognized output type (currently "pattern")
- `value` must be a valid pattern JSON structure

**Relationships**:
- Used by `TestCase.expected`

---

### TestOperation

Represents an operation to test against a pattern (e.g., pattern matching).

**Fields**:
- `op :: Text` - Operation name (e.g., "match")
- `against :: Text` - Pattern or data to operate against (gram notation)
- `expectedBindings :: Maybe [Binding]` - Expected variable bindings or results

**Invariants**:
- `op` must be a recognized operation name
- `against` must be valid gram notation
- `expectedBindings` is optional (some operations may not produce bindings)

**Relationships**:
- Part of `TestCase.operations` array

---

## Output Formatting Structures

### CanonicalJSON

Represents JSON output with sorted keys at all nesting levels.

**Structure**: Standard JSON `Value` type from aeson, but with all object keys sorted alphabetically recursively.

**Invariants**:
- All object keys sorted alphabetically
- Consistent formatting (no optional whitespace)
- Deterministic across runs for equivalent data

**Relationships**:
- Produced when `OutputOptions.canonical` is `True`
- Used by all commands when `--canonical` flag is used

---

### ValueOnlyOutput

Represents output containing only the result value without metadata wrapper.

**Structure**: 
- For success: Just the pattern JSON value (no `Meta`, `Result`, or `Diagnostics` wrapper)
- For error: Just the error object (no `Error` wrapper)

**Invariants**:
- No metadata fields present
- Direct result value or error object
- Compatible with `canonical` flag

**Relationships**:
- Produced when `OutputOptions.valueOnly` is `True`
- Used by all commands when `--value-only` flag is used

---

## State Transitions

### Output Generation Flow

1. **Command Execution**: CLI command produces result (pattern, error, etc.)
2. **Options Application**: `OutputOptions` applied to determine formatting
3. **JSON Serialization**: Result serialized to JSON `Value`
4. **Canonicalization** (if `canonical=True`): Keys sorted recursively
5. **Metadata Handling** (if `valueOnly=True` or `deterministic=True`): Metadata excluded or fixed
6. **Final Encoding**: JSON `Value` encoded to `Text` output

### Test Suite Generation Flow

1. **Seed Initialization**: `--seed` parameter used to create `StdGen`
2. **Complexity Selection**: `--complexity` parameter determines generator strategy
3. **Test Case Generation**: Deterministic generation of N test cases (where N = `--count`)
4. **Test Case Assembly**: Each test case includes name, description, input, expected, operations
5. **Suite Assembly**: Test cases collected into `TestSuite` structure
6. **JSON Serialization**: `TestSuite` serialized to JSON following test suite format

---

## Validation Rules

### OutputOptions Validation

- `deterministic=True` → `canonical=True` (automatic, per FR-011)

### TestSuite Validation

- `version` must be "1.0" (or valid version string)
- `testCases` array must contain valid `TestCase` objects
- All test case `name` fields must be unique within the suite
- All `input.value` must be valid gram notation
- All `expected.value` must be valid pattern JSON structures

### TestCase Validation

- `name` must be non-empty and unique
- `description` must be non-empty
- `input.type` must be "gram_notation" (or recognized type)
- `expected.type` must be "pattern" (or recognized type)
- If `operations` is present, all operations must be valid

---

## Data Flow

```
CLI Command
  ↓
Result (Pattern | Error)
  ↓
OutputOptions + OutputFormat
  ↓
JSON Value (with optional canonicalization)
  ↓
Final Output (Text)
```

```
Generate Command
  ↓
Seed + Complexity + Count
  ↓
Test Case Generators
  ↓
[TestCase, ...]
  ↓
TestSuite
  ↓
JSON Serialization
  ↓
Test Suite Output (Text)
```

---

## Notes

- No changes to core `Pattern`, `Subject`, or `Gram` types
- Output formatting extends existing functionality
- Test suite generation is new functionality

